---
title: "p8105_hw5_cl4043"
author: "Stella Li"
date: "11/11/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(purrr)
library(stringr)
library(patchwork)
```

## Problem 1

```{r message=FALSE, warning=FALSE}
homicide_df = 
  read_csv("./homicide_data.csv") %>%
  mutate( city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest" ~ "unsolved",
      disposition == "Closed by arrest" ~ "solved",
    )
  ) %>%
  filter(city_state != "Tulsa_AL") %>%
  select(city_state, resolved)
```
looking at the table


```{r}
agg_df = homicide_df %>%
  group_by(city_state) %>%
  summarize(hom_total = n(),
            hom_unsolved = sum(resolved == "unsolved")
            )
```

prop test on single city

```{r}

prop.test(
  agg_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved),
  agg_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>%
  broom::tidy()


results_df = 
  agg_df%>%
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x=.x, n= .y)), tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>%
  select(-prop_tests) %>%
  unnest(tidy_tests) %>%
  select(city_state, estimate, conf.low, conf.high)
```


```{r}
results_df %>%
  mutate(city_state = fct_reorder(city_state, estimate)) %>%
  ggplot(aes(x = city_state, y= estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Problem 2

```{r, message = FALSE}
path_df = 
  tibble(
    path = list.files("lda_data"),) %>%
  mutate(
    path = str_c("lda_data/", path),
    data = map(path, read_csv)) %>%
  unnest(data) %>%
  mutate(group = substr(path, 20, 22), id = substr(path, 24, 25), id = str_c(group, id)) %>%
  select(-path) %>%
  pivot_longer(week_1:week_8, names_to = "week", names_prefix = "week_", values_to = "obs") %>%
  mutate(week = as.factor(week), id = as.factor(id))%>% group_by(id)
path_df %>%
  ggplot(aes(x = week, y = obs, group = id, color = group)) +
  geom_line() +
  labs(
    title = "Observations for Each Subject Over 8 Weeks",
    x = "Week Number",
    y = "Observation Value")

```
The experimental group's scores tend to increase from the beginning to the end of the study, while the control group's scores tend to decrease for the entire period. 


## Problem 3

```{r}
set.seed(1)
sim_data = function(mu) {
  
    x = rnorm(n = 30, mean = mu, sd = 5)
  
  t.test(x = x, mu = 0, alternative = "two.sided") %>% 
    broom::tidy() %>% 
    select(estimate, p.value)
}

sim_results = tibble(
  mu = c(0, 1, 2, 3, 4, 5, 6) 
  ) %>%
  mutate(output_lists = map(.x = mu, ~rerun(5000, sim_datasets(mu = .x)))
         ) %>%
  unnest(output_lists) %>%
  unnest(output_lists) %>%
  mutate(reject_null = if_else(p.value < 0.05, 1, 0))
```


```{r}
# first plot
sim_results %>% 
  group_by(mu) %>%
  summarize(prop_reject = sum(reject_null)/5000) %>%
  ggplot(aes(x = mu, y = prop_reject)) +
  geom_line() +
  labs(
    title = "Proportion of times the Null was rejected for each mu",
    x = "mu",
    y = "Proportion of times the Null was rejected")
```
As the effect size increases, the power increases. The difference between the null mu (0) and the actual mu increases, the power also increases, and as we can see from the results, the difference between the null mu and the actual mu increases.

```{r}
avg_results <- sim_results %>% 
  group_by(mu) %>%
  summarize(mean_mu_hat = mean(estimate)) %>%
  ggplot(aes(x = mu, y = mean_mu_hat)) +
  geom_boxplot() 

avg_rejected_results <- sim_results %>% 
  filter(reject_null == 1) %>%
  group_by(mu) %>%
  summarize(mean_mu_hat = mean(estimate)) %>%
  ggplot(aes(x = mu, y = mean_mu_hat)) +
  geom_boxplot() 

avg_results + avg_rejected_results
```
